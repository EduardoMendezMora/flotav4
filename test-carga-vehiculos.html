<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carga de Veh√≠culos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>üß™ Test de Carga de Veh√≠culos</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-car me-2"></i>Test de API</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="testCargarVehiculos()">
                            <i class="fas fa-play"></i> Cargar Veh√≠culos
                        </button>
                        <button class="btn btn-success mb-3" onclick="testCargarMarcas()">
                            <i class="fas fa-tags"></i> Cargar Marcas
                        </button>
                        <button class="btn btn-info mb-3" onclick="testCargarArrendadoras()">
                            <i class="fas fa-building"></i> Cargar Arrendadoras
                        </button>
                        <button class="btn btn-warning mb-3" onclick="testCargarColores()">
                            <i class="fas fa-palette"></i> Cargar Colores
                        </button>
                        <button class="btn btn-danger mb-3" onclick="testConexionDirecta()">
                            <i class="fas fa-wifi"></i> Probar Conexi√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Resultados</h6>
                    </div>
                    <div class="card-body">
                        <div id="results" class="small">
                            <p>üîÑ Haz clic en los botones para probar la carga de datos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script>
        // Verificar que la configuraci√≥n est√© disponible
        if (typeof SUPABASE_CONFIG === 'undefined') {
            console.error('SUPABASE_CONFIG no est√° definido. Verifica que config.js est√© cargado correctamente.');
            document.getElementById('results').innerHTML = '<p class="text-danger">‚ùå Error: SUPABASE_CONFIG no est√° definido. Verifica config.js</p>';
        } else {
            const api = new ApiService();

            function log(message, type = 'info') {
                const resultsDiv = document.getElementById('results');
                const timestamp = new Date().toLocaleTimeString();
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                resultsDiv.innerHTML += `<p>[${timestamp}] ${icon} ${message}</p>`;
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }

            async function testCargarVehiculos() {
                log('üöó Iniciando carga de veh√≠culos...');
                try {
                    log(`üîó URL de la API: ${api.baseUrl}`, 'info');
                    const response = await api.getVehiculos();
                    log(`üìä Respuesta recibida: ${JSON.stringify(response).substring(0, 200)}...`, 'info');
                    
                    if (response && response.success && response.data && Array.isArray(response.data)) {
                        if (response.data.length > 0) {
                            log(`‚úÖ Se cargaron ${response.data.length} veh√≠culos correctamente`, 'success');
                            log(`üìã Primer veh√≠culo: ${response.data[0].placa} - ID: ${response.data[0].id}`, 'info');
                        } else {
                            log('‚ö†Ô∏è Se recibi√≥ un array vac√≠o - no hay veh√≠culos en la base de datos', 'warning');
                        }
                    } else {
                        log(`‚ö†Ô∏è Respuesta inesperada: ${typeof response}`, 'warning');
                        log(`üìã Contenido: ${JSON.stringify(response)}`, 'info');
                    }
                } catch (error) {
                    log(`‚ùå Error cargando veh√≠culos: ${error.message}`, 'error');
                    log(`üîç Stack trace: ${error.stack}`, 'error');
                    console.error('Error completo:', error);
                }
            }

            async function testCargarMarcas() {
                log('üè∑Ô∏è Iniciando carga de marcas...');
                try {
                    const response = await api.getMarcas();
                    log(`üìä Respuesta marcas: ${JSON.stringify(response).substring(0, 100)}...`, 'info');
                    
                    if (response && response.success && response.data && Array.isArray(response.data)) {
                        if (response.data.length > 0) {
                            log(`‚úÖ Se cargaron ${response.data.length} marcas correctamente`, 'success');
                            log(`üìã Marcas: ${response.data.map(m => m.nombre).join(', ')}`, 'info');
                        } else {
                            log('‚ö†Ô∏è Se recibi√≥ un array vac√≠o - no hay marcas en la base de datos', 'warning');
                        }
                    } else {
                        log(`‚ö†Ô∏è Respuesta inesperada: ${typeof response}`, 'warning');
                    }
                } catch (error) {
                    log(`‚ùå Error cargando marcas: ${error.message}`, 'error');
                    console.error('Error completo:', error);
                }
            }

            async function testCargarArrendadoras() {
                log('üè¢ Iniciando carga de arrendadoras...');
                try {
                    const response = await api.getArrendadoras();
                    log(`üìä Respuesta arrendadoras: ${JSON.stringify(response).substring(0, 100)}...`, 'info');
                    
                    if (response && response.success && response.data && Array.isArray(response.data)) {
                        if (response.data.length > 0) {
                            log(`‚úÖ Se cargaron ${response.data.length} arrendadoras correctamente`, 'success');
                            log(`üìã Arrendadoras: ${response.data.map(a => a.nombre).join(', ')}`, 'info');
                        } else {
                            log('‚ö†Ô∏è Se recibi√≥ un array vac√≠o - no hay arrendadoras en la base de datos', 'warning');
                        }
                    } else {
                        log(`‚ö†Ô∏è Respuesta inesperada: ${typeof response}`, 'warning');
                    }
                } catch (error) {
                    log(`‚ùå Error cargando arrendadoras: ${error.message}`, 'error');
                    console.error('Error completo:', error);
                }
            }

            async function testCargarColores() {
                log('üé® Iniciando carga de colores...');
                try {
                    const response = await api.getColores();
                    log(`üìä Respuesta colores: ${JSON.stringify(response).substring(0, 100)}...`, 'info');
                    
                    if (response && response.success && response.data && Array.isArray(response.data)) {
                        if (response.data.length > 0) {
                            log(`‚úÖ Se cargaron ${response.data.length} colores correctamente`, 'success');
                            log(`üìã Colores: ${response.data.map(c => c.nombre).join(', ')}`, 'info');
                        } else {
                            log('‚ö†Ô∏è Se recibi√≥ un array vac√≠o - no hay colores en la base de datos', 'warning');
                        }
                    } else {
                        log(`‚ö†Ô∏è Respuesta inesperada: ${typeof response}`, 'warning');
                    }
                } catch (error) {
                    log(`‚ùå Error cargando colores: ${error.message}`, 'error');
                    console.error('Error completo:', error);
                }
            }

            async function testConexionDirecta() {
                log('üåê Probando conexi√≥n directa a la API...');
                try {
                    const url = `${api.baseUrl}/marcas?select=*&limit=1`;
                    log(`üîó URL de prueba: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: api.headers
                    });
                    
                    log(`üìä Status HTTP: ${response.status} ${response.statusText}`, 'info');
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ Conexi√≥n exitosa! Respuesta: ${JSON.stringify(data)}`, 'success');
                    } else {
                        log(`‚ùå Error HTTP: ${response.status} - ${response.statusText}`, 'error');
                        const errorText = await response.text();
                        log(`üìã Detalles del error: ${errorText}`, 'error');
                    }
                } catch (error) {
                    log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    console.error('Error completo:', error);
                }
            }

            // Hacer las funciones globales para que los botones puedan acceder a ellas
            window.testCargarVehiculos = testCargarVehiculos;
            window.testCargarMarcas = testCargarMarcas;
            window.testCargarArrendadoras = testCargarArrendadoras;
            window.testCargarColores = testCargarColores;
            window.testConexionDirecta = testConexionDirecta;

            // Inicializar
            log('üöÄ Test de carga de veh√≠culos iniciado');
            log('üîß Verificando configuraci√≥n de API...');
            
            // Verificar configuraci√≥n
            if (api.baseUrl) {
                log(`‚úÖ API configurada: ${api.baseUrl}`, 'success');
            } else {
                log('‚ùå API no configurada correctamente', 'error');
            }
        }
    </script>
</body>
</html>
